<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Knowledge Engine v9 - Hierarchical Nav & Ranked Search</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <style>
    :root {
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04); --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);

      /* Light Theme Colors */
      --c-disease-light: #d946ef; --c-disease-bg-light: #fae8ff;
      --c-structure-light: #6366f1; --c-structure-bg-light: #e0e7ff;
      --c-process-light: #f97316; --c-process-bg-light: #ffedd5;
      --c-substance-light: #14b8a6; --c-substance-bg-light: #ccfbf1;
      --c-finding-light: #0ea5e9; --c-finding-bg-light: #e0f2fe;
      --c-concept-light: #84cc16; --c-concept-bg-light: #ecfccb;
      --text-light: #1f2937; --bg-light: #f9fafb; --node-bg-light: #ffffff; --bg-alt-light: #f3f4f6;
      --line-light: #e5e7eb; --text-muted-light: #6b7280; --link-light: #4f46e5;

      /* Dark Theme Colors */
      --c-disease-dark: #c084fc; --c-disease-bg-dark: #3b0764;
      --c-structure-dark: #a5b4fc; --c-structure-bg-dark: #3730a3;
      --c-process-dark: #fb923c; --c-process-bg-dark: #4a210b;
      --c-substance-dark: #2dd4bf; --c-substance-bg-dark: #0f766e;
      --c-finding-dark: #38bdf8; --c-finding-bg-dark: #0c4a6e;
      --c-concept-dark: #a3e635; --c-concept-bg-dark: #3f6212;
      --text-dark: #d1d5db; --bg-dark: #111827; --node-bg-dark: #1f2937; --bg-alt-dark: #374151;
      --line-dark: #374151; --text-muted-dark: #9ca3af; --link-dark: #818cf8;
    }

    :root {
      --bg-color: var(--bg-light); --node-bg: var(--node-bg-light); --bg-alt-color: var(--bg-alt-light);
      --line-color: var(--line-light); --text-color: var(--text-light); --text-muted: var(--text-muted-light);
      --link-color: var(--link-light);
    }
    html[data-theme='dark'] {
      --bg-color: var(--bg-dark); --node-bg: var(--node-bg-dark); --bg-alt-color: var(--bg-alt-dark);
      --line-color: var(--line-dark); --text-color: var(--text-dark); --text-muted: var(--text-muted-dark);
      --link-color: var(--link-dark);
    }

    .type-disease   { --type-color: var(--c-disease-light);   --type-bg: var(--c-disease-bg-light); }
    .type-structure { --type-color: var(--c-structure-light); --type-bg: var(--c-structure-bg-light); }
    .type-process   { --type-color: var(--c-process-light);   --type-bg: var(--c-process-bg-light); }
    .type-substance { --type-color: var(--c-substance-light); --type-bg: var(--c-substance-bg-light); }
    .type-finding   { --type-color: var(--c-finding-light);   --type-bg: var(--c-finding-bg-light); }
    .type-concept   { --type-color: var(--c-concept-light);   --type-bg: var(--c-concept-bg-light); }

    html[data-theme='dark'] .type-disease   { --type-color: var(--c-disease-dark);   --type-bg: var(--c-disease-bg-dark); }
    html[data-theme='dark'] .type-structure { --type-color: var(--c-structure-dark); --type-bg: var(--c-structure-bg-dark); }
    html[data-theme='dark'] .type-process   { --type-color: var(--c-process-dark);   --type-bg: var(--c-process-bg-dark); }
    html[data-theme='dark'] .type-substance { --type-color: var(--c-substance-dark); --type-bg: var(--c-substance-bg-dark); }
    html[data-theme='dark'] .type-finding   { --type-color: var(--c-finding-dark);   --type-bg: var(--c-finding-bg-dark); }
    html[data-theme='dark'] .type-concept   { --type-color: var(--c-concept-dark);   --type-bg: var(--c-concept-bg-dark); }

    html { scroll-behavior: smooth; }
    body, html { margin:0; padding:0; height:100%; font-family:var(--font-main); background-color:var(--bg-color); color:var(--text-color); transition: background-color .2s, color .2s; -webkit-font-smoothing: antialiased; }
    ::selection { background-color: var(--type-color, var(--c-structure-light)); color:#fff; }
    .emoji { display:inline-block; margin-right:.5em; vertical-align:-0.1em; }

    .container { display:flex; height:100vh; }
    .nav-panel { width:22%; min-width:280px; background:var(--node-bg); border-right:1px solid var(--line-color); padding:1.25rem; overflow-y:auto; display:flex; flex-direction:column; transition:all .2s; }
    .main-panel { flex-grow:1; padding:2.5rem; overflow-y:auto; }
    .connections-panel { width:25%; min-width:320px; background:var(--bg-alt-color); border-left:1px solid var(--line-color); padding:1.25rem; overflow-y:auto; transition:all .2s; }

    .nav-controls { display:flex; gap:.5rem; margin-bottom:1rem; }
    .import-btn, .theme-btn { flex-grow:1; font-family:var(--font-main); font-size:14px; padding:.6rem .75rem; border-radius:var(--radius-md); border:1px solid var(--line-color); background:transparent; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:.5rem; transition:all .2s; font-weight:500; }
    .import-btn { background-color: var(--c-structure-light); color:#fff; border-color:transparent; }
    html[data-theme='dark'] .import-btn { background-color: var(--c-structure-dark); }
    .theme-btn:hover { background-color:var(--bg-alt-color); color:var(--text-color); border-color:var(--text-muted); }

    #search-input { width:100%; box-sizing:border-box; font-family:var(--font-main); font-size:14px; padding:.6rem .8rem; border-radius:var(--radius-md); border:1px solid var(--line-color); background-color:var(--bg-alt-color); color:var(--text-color); margin-bottom:1rem; }
    #search-input:focus { outline:none; border-color:var(--c-structure-light); box-shadow:0 0 0 2px var(--c-structure-bg-light); }
    html[data-theme='dark'] #search-input:focus { border-color:var(--c-structure-dark); box-shadow:0 0 0 2px var(--c-structure-bg-dark); }

    .nav-panel h3 { margin:0 0 .5rem 0; font-size:1rem; text-transform:uppercase; letter-spacing:.05em; color:var(--text-muted); }
    .nav-panel ul { list-style:none; padding-left:0; }
    .nav-panel a { text-decoration:none; color:var(--text-muted); cursor:pointer; padding:.5rem .75rem; border-radius:var(--radius-md); font-weight:500; transition:background-color .2s, color .2s; display:flex; align-items:center; justify-content:space-between; gap:.25rem; margin-bottom:2px; }
    .nav-panel a .topic-title { display:flex; align-items:center; gap:.25rem; }
    .nav-panel a:hover { background-color:var(--bg-alt-color); color:var(--text-color); }
    .nav-panel a.active { background-color:var(--type-bg); color:var(--type-color); font-weight:600; }

    /* hierarchical navigation */
    #nav-list details { margin-left:1rem; }
    #nav-list summary { font-weight:600; color:var(--text-color); cursor:pointer; padding:.5rem; border-radius:var(--radius-md); list-style-position:inside; }
    #nav-list summary:hover { background-color:var(--bg-alt-color); }
    #nav-list details ul { padding-left:.5rem; border-left:1px solid var(--line-color); margin-left:.5rem; }
    #nav-list details[open] > summary { margin-bottom:.25rem; }

    /* search results */
    .relevance-score { font-size:.75em; color:var(--text-muted); background-color:var(--bg-alt-color); padding:2px 6px; border-radius:99px; }
    a:hover .relevance-score { background-color:var(--node-bg); }
    a.active .relevance-score { background-color:var(--node-bg); color:var(--type-color); }

    .topic-header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid var(--line-color); padding-bottom:1rem; margin-bottom:1.5rem; }
    .topic-header-main { display:flex; align-items:center; gap:1rem; }
    .topic-icon { font-size:2rem; width:48px; height:48px; flex-shrink:0; border-radius:var(--radius-md); background-color:var(--type-bg); display:flex; align-items:center; justify-content:center; }
    .topic-header h2 { margin:0; font-size:2.25rem; }
    .tags-container { margin-top:.5rem; display:flex; flex-wrap:wrap; gap:.5rem; }
    .tag-item { background-color:var(--bg-alt-color); border:1px solid var(--line-color); color:var(--text-muted); padding:2px 8px; border-radius:99px; font-size:.75em; font-weight:500; }
    .topic-header button { font-family:var(--font-main); background:var(--bg-alt-color); color:var(--text-color); border:1px solid var(--line-color); padding:.5rem 1rem; border-radius:var(--radius-md); cursor:pointer; font-weight:500; transition:all .2s; }
    .topic-header button:hover { background-color:var(--line-color); border-color:var(--text-muted); }

    h4 .emoji { font-size:.9em; }
    .at-a-glance { padding:1.25rem; margin-bottom:1.5rem; border-radius:var(--radius-md); background:var(--type-bg); border-left:4px solid var(--type-color); color:var(--type-color);}
    .at-a-glance ul { margin:0; padding-left:1.25rem; }
    .at-a-glance li, .at-a-glance p, .at-a-glance b, .at-a-glance strong { color:inherit; }

    .classification-path { color:var(--text-muted); font-size:.9em; margin-bottom:1.5rem; }
    .internal-link { color:var(--link-color); font-weight:600; text-decoration:none; border-bottom:1px solid transparent; transition:border-color .2s; }
    .internal-link:hover { border-color:currentColor; }

    .connections-panel h3, .connections-panel h4 { margin-top:0; }
    .connections-panel ul { list-style:none; padding:0; margin-bottom:1.5rem; }
    .connections-panel li { background-color:var(--node-bg); border-radius:var(--radius-md); padding:.75rem 1rem; margin-bottom:.5rem; box-shadow:var(--shadow-sm); border:1px solid var(--line-color); }
    .connection-label { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.05em; padding:.2em .6em; border-radius:var(--radius-sm); margin-left:.5rem; }

    #popover { display:none; position:absolute; background-color:var(--node-bg); border:1px solid var(--line-color); box-shadow:var(--shadow-lg); padding:1rem; z-index:1000; max-width:320px; border-radius:var(--radius-lg); pointer-events:none; }
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background-color:rgba(17,24,39,0.8); backdrop-filter: blur(4px); }
    .modal-content { background-color:var(--bg-color); margin:5% auto; padding:20px; border:1px solid var(--line-color); width:80%; max-width:1200px; height:80%; display:flex; flex-direction:column; border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line-color); padding-bottom:10px; margin-bottom:1rem; }
    .close-btn { color:var(--text-muted); font-size:28px; font-weight:bold; cursor:pointer; }
    .close-btn:hover { color:var(--text-color); }

    /* Graph container needs explicit size */
    #graph-container {
      width:100%;
      height:calc(100% - 60px);  /* reserve space for modal header */
      min-height:480px;          /* safety for small viewports */
    }
  </style>
</head>
<body>

<div class="container">
  <div class="nav-panel"></div>
  <div class="main-panel" id="main-panel"></div>
  <div class="connections-panel" id="connections-panel"></div>
</div>

<div id="popover"></div>

<div id="graph-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><span class="emoji">üï∏Ô∏è</span>Knowledge Graph</h2>
      <span class="close-btn" onclick="closeModal('graph-modal')">&times;</span>
    </div>
    <div id="graph-container"></div>
  </div>
</div>

<script>
  let knowledgeBase = {};
  let activeTopicId = null;
  let fuse = null;
  let currentNetwork = null; // track vis.js instance

  const EMOJI_MAP = {
    disease: 'ü¶†', structure: 'üî¨', process: '‚öôÔ∏è',
    substance: 'üíä', finding: 'ü©∫', concept: 'üß†'
  };
  const getEmoji = (type) => EMOJI_MAP[type] || 'üí°';

  /* ---------- Relation display mapping (normalize verbs & opposites) ---------- */
  // family Áî®‰∫éÈÄâÊã©‰∏çÂêåËâ≤Á≥ªÔºõout Ë°®Á§∫ FromÔºàÊú¨‰∏ªÈ¢ò‰∏∫‰∏ªËØ≠ÔºâÔºåin Ë°®Á§∫ ToÔºàÂØπÊñπ‰∏∫‰∏ªËØ≠Ôºâ
  const RELATION_DISPLAY = {
    causes:                { family: 'path',      out: 'causes',              in: 'is caused by' },
    is_manifestation_of:   { family: 'path',      out: 'manifests as',        in: 'is manifestation of' },

    treated_by:            { family: 'therapy',   out: 'treated by',          in: 'treats' },
    is_treatment_for:      { family: 'therapy',   out: 'treats',              in: 'is treatment for' },

    diagnosed_by:          { family: 'diagnosis', out: 'diagnosed by',        in: 'diagnoses' },
    is_diagnostic_for:     { family: 'diagnosis', out: 'diagnoses',           in: 'is diagnostic for' },

    secretes_excess:       { family: 'biochem',   out: 'secretes excess',     in: 'is secreted in excess by' },

    associated_with:       { family: 'assoc',     out: 'associated with',     in: 'associated with' },
  };
  const fallbackLabel = (t) => (t || '').replace(/_/g,' ');
  const labelFor = (t, dir) => (RELATION_DISPLAY[t]?.[dir]) || fallbackLabel(t);
  function chipStyleFor(type, isDark){
    const fam = RELATION_DISPLAY[type]?.family;
    const tone = isDark ? 'dark' : 'light';
    if (fam === 'therapy')   return `background:var(--c-substance-bg-${tone});color:var(--c-substance-${tone})`;
    if (fam === 'diagnosis') return `background:var(--c-finding-bg-${tone});color:var(--c-finding-${tone})`;
    if (fam === 'path')      return `background:var(--c-process-bg-${tone});color:var(--c-process-${tone})`;
    if (fam === 'biochem')   return `background:var(--c-concept-bg-${tone});color:var(--c-concept-${tone})`;
    if (fam === 'assoc')     return `background:var(--bg-alt-color);color:var(--text-muted)`;
    return `background:var(--bg-alt-color);color:var(--text-muted)`;
  }

  /* ---------------------------- Search indexing ----------------------------- */
  function initializeSearchIndex() {
    const stripHtml = (html) => (new DOMParser().parseFromString(html, 'text/html')).body.textContent || '';
    const generateAcronym = (title) => {
      const words = title.split(' ').filter(word => /^[A-Z]/.test(word));
      return words.length > 1 ? words.map(w => w[0]).join('') : '';
    };
    const searchableData = Object.entries(knowledgeBase)
      .filter(([id]) => !id.startsWith('zzz_'))
      .map(([id, topic]) => {
        const fullContent = Object.values(topic.content || {}).map(stripHtml).join(' ');
        return { id, title: topic.title, acronym: generateAcronym(topic.title), primaryType: topic.primaryType, tags: topic.tags || [], fullContent };
      });
    const fuseOptions = {
      keys: [{ name: 'title', weight: 1.0 }, { name: 'acronym', weight: 0.9 }, { name: 'tags', weight: 0.7 }, { name: 'fullContent', weight: 0.2 }],
      includeScore: true, threshold: 0.4, minMatchCharLength: 2, ignoreLocation: true
    };
    fuse = new Fuse(searchableData, fuseOptions);
  }

  function filterTopics(event) {
    if (!fuse) return;
    const searchTerm = event.target.value.trim();
    if (!searchTerm) { renderNav(); return; }
    const results = fuse.search(searchTerm);
    renderSearchResults(results);
  }

  function renderSearchResults(results) {
    const navList = document.getElementById('nav-list');
    navList.innerHTML = '';
    if (results.length === 0) {
      const noResults = document.createElement('li');
      noResults.textContent = 'No results found.';
      noResults.style.padding = '0.5rem 0.75rem';
      noResults.style.color = 'var(--text-muted)';
      navList.appendChild(noResults);
      return;
    }
    results.forEach(result => {
      const topic = knowledgeBase[result.item.id];
      if (!topic) return;
      const relevance = (1 - result.score) * 100;
      const item = document.createElement('li');
      const link = document.createElement('a');
      link.id = `nav-${topic.id}`;
      link.onclick = () => showTopic(result.item.id);
      link.innerHTML = `
        <span class="topic-title">
          <span class="emoji">${getEmoji(topic.primaryType)}</span>
          <span>${topic.title}</span>
        </span>
        <span class="relevance-score" title="Relevance Score">${relevance.toFixed(0)}%</span>`;
      if (result.item.id === activeTopicId) link.classList.add('active');
      item.appendChild(link);
      navList.appendChild(item);
    });
  }

  function initializeApp() {
    renderNavPanelBase();
    setupTheme();
    setupPopover();
    showWelcomeMessage();
  }

  function renderNavPanelBase() {
    document.querySelector('.nav-panel').innerHTML = `
      <div class="nav-controls">
        <input type="file" id="json-importer" multiple accept=".json" style="display:none;">
        <label for="json-importer" class="import-btn"><span class="emoji">üì•</span>Import</label>
        <button id="theme-toggle" class="theme-btn" title="Toggle Theme"><span class="emoji">üé®</span>Theme</button>
      </div>
      <input type="text" id="search-input" placeholder="üîç Search (e.g., 'UC', 'fistula', 'cronhs')...">
      <div id="nav-content">
        <h3>Topics</h3>
        <ul id="nav-list"><li>No topics loaded.</li></ul>
      </div>`;
    document.getElementById('json-importer').addEventListener('change', handleFileSelect);
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('search-input').addEventListener('input', filterTopics);
  }

  function showWelcomeMessage() {
    document.getElementById('main-panel').innerHTML =
      '<div style="text-align:center; margin-top: 4rem;"><h2><span class="emoji">üëã</span> Welcome to your Knowledge Engine</h2><p style="color:var(--text-muted)">Import one or more JSON files to begin. Enjoy the new hierarchical navigation and ranked search!</p></div>';
    document.getElementById('connections-panel').innerHTML = '';
  }

  function setupTheme() {
    const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', currentTheme);
  }

  function toggleTheme() {
    const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    // ‰∏ªÈ¢òÂàáÊç¢ÂêéÔºåÂè≥Ê†èÈ¢úËâ≤Áî® CSS ÂèòÈáè‰ºöËá™Âä®ÈÄÇÈÖçÔºõvis-network È¢úËâ≤Â∑≤Áî®Ëß£ÊûêÊñπÊ°à
  }

  async function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length === 0) return;
    let newTopicsCount = 0, updatedTopicsCount = 0;
    const fileReadPromises = Array.from(files).map(file => file.text().then(JSON.parse));
    try {
      const allNewData = await Promise.all(fileReadPromises);
      allNewData.forEach(data => {
        for (const key in data) {
          if (key.startsWith('zzz_')) continue;
          if (!knowledgeBase[key]) newTopicsCount++; else updatedTopicsCount++;
          knowledgeBase[key] = data[key];
        }
      });
      alert(`Import successful!\n- ${newTopicsCount} new topics added.\n- ${updatedTopicsCount} topics updated.`);
      initializeSearchIndex();
      renderUI();
    } catch (error) {
      console.error('Error reading/parsing JSON:', error);
      alert('Import failed. Please check file format.');
    }
    event.target.value = '';
  }

  function renderUI() {
    document.getElementById('search-input').value = '';
    renderNav();
    const firstTopicId = Object.keys(knowledgeBase)
      .sort((a,b) => knowledgeBase[a].title.localeCompare(knowledgeBase[b].title))[0];
    if (firstTopicId) showTopic(firstTopicId);
  }

  function renderNav() {
    const navList = document.getElementById('nav-list');
    navList.innerHTML = '';
    const navTree = {};
    Object.entries(knowledgeBase)
      .filter(([id, topic]) => topic.classificationPath && topic.classificationPath.length > 0)
      .sort(([, a], [, b]) => a.title.localeCompare(b.title))
      .forEach(([id, topic]) => {
        let currentNode = navTree;
        topic.classificationPath.forEach((pathPart, index) => {
          if (!currentNode[pathPart]) {
            currentNode[pathPart] = { _children: {}, _items: [] };
          }
          if (index === topic.classificationPath.length - 1) {
            currentNode[pathPart]._items.push({ id, ...topic });
          }
          currentNode = currentNode[pathPart]._children;
        });
      });

    function createNavHtml(treeNode) {
      const ul = document.createElement('ul');
      const sortedKeys = Object.keys(treeNode).sort();
      for (const key of sortedKeys) {
        const node = treeNode[key];
        const li = document.createElement('li');
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.textContent = key;
        details.appendChild(summary);
        if (Object.keys(node._children).length > 0) {
          details.appendChild(createNavHtml(node._children));
        }
        if (node._items.length > 0) {
          const itemUl = document.createElement('ul');
          node._items.forEach(topic => {
            const itemLi = document.createElement('li');
            const link = document.createElement('a');
            link.id = `nav-${topic.id}`;
            link.onclick = () => showTopic(topic.id);
            link.innerHTML = `<span class="topic-title"><span class="emoji">${getEmoji(topic.primaryType)}</span><span>${topic.title}</span></span>`;
            itemLi.appendChild(link);
            itemUl.appendChild(itemLi);
          });
          details.appendChild(itemUl);
        }
        li.appendChild(details);
        ul.appendChild(li);
      }
      return ul;
    }

    const navHtml = createNavHtml(navTree);
    navList.appendChild(navHtml);
    updateActiveNav();
  }

  function updateActiveNav() {
    document.querySelectorAll('.nav-panel a.active').forEach(el => el.classList.remove('active'));
    if (activeTopicId) {
      const activeLink = document.getElementById(`nav-${activeTopicId}`);
      if (activeLink) {
        activeLink.classList.add('active');
        let parent = activeLink.closest('details');
        while (parent) {
          parent.open = true;
          parent = parent.parentElement.closest('details');
        }
      }
    }
  }

  function parseAndLinkContent(text) {
    if (!text) return '';
    return text.replace(/\[\[([a-zA-Z0-9_]+)(?:\|(.+?))?\]\]/g, (match, topicId, displayText) => {
      if (knowledgeBase[topicId]) {
        const linkText = displayText || knowledgeBase[topicId].title;
        return `<a class="internal-link" data-topic-id="${topicId}" onclick="showTopic('${topicId}')">${linkText}</a>`;
      }
      return `<em>${displayText || topicId}</em>`;
    });
  }

  function showTopic(topicId) {
    if (!knowledgeBase[topicId]) return;
    activeTopicId = topicId;
    const topic = knowledgeBase[topicId];
    const mainPanel = document.getElementById('main-panel');
    mainPanel.className = `main-panel type-${topic.primaryType || 'concept'}`;

    updateActiveNav();

    const tagsHtml = topic.tags ? `<div class="tags-container">${topic.tags.map(t => `<span class="tag-item">${t}</span>`).join('')}</div>` : '';
    const pathHtml = topic.classificationPath ? `<div class="classification-path"><span class="emoji">üó∫Ô∏è</span> ${topic.classificationPath.join(' &rsaquo; ')}</div>` : '';
    mainPanel.innerHTML = `
      <div class="topic-header">
        <div class="topic-header-main">
          <div class="topic-icon">${getEmoji(topic.primaryType)}</div>
          <div>
            <h2>${topic.title}</h2>
            ${tagsHtml}
          </div>
        </div>
        <button onclick="showGraphModal('${topicId}')"><span class="emoji">üï∏Ô∏è</span>Graph View</button>
      </div>
      <h4><span class="emoji">üëÄ</span>At a Glance</h4>
      <div class="at-a-glance">${parseAndLinkContent(topic.content?.atAGlance || '')}</div>
      ${pathHtml}
      ${Object.keys(topic.content || {}).filter(k => !['definition', 'atAGlance', 'takeAway'].includes(k)).map(k => `<h4>${k.charAt(0).toUpperCase() + k.slice(1)}</h4><p>${parseAndLinkContent(topic.content[k])}</p>`).join('')}
      <div style="background:var(--bg-alt-color); padding:1rem; border-radius:var(--radius-md); margin-top:2rem;">
        <h4><span class="emoji">üîë</span>Key Take Away</h4>
        <p>${parseAndLinkContent(topic.content?.takeAway || '')}</p>
      </div>`;
    renderConnections(topicId);
    mainPanel.scrollTop = 0;
  }

  /* --------------------- Connections (active-voice, clearer) --------------------- */
  function renderConnections(topicId) {
    const connectionsPanel = document.getElementById('connections-panel');
    const topic = knowledgeBase[topicId];
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    // Outgoing: Êú¨‰∏ªÈ¢ò ‚Üí ÂÖ∂‰ªñ
    let outHtml = `<h3><span class="emoji">üîó</span>Connections</h3><h4>From ${topic.title}</h4><ul>`;
    if (Array.isArray(topic.connections) && topic.connections.length > 0) {
      topic.connections.forEach(conn => {
        const other = knowledgeBase[conn.to];
        if (!other) return;
        const label = labelFor(conn.type, 'out');           // Áªü‰∏Ä‰∏ªÂä®ÊÄÅ
        const style = chipStyleFor(conn.type, isDark);
        outHtml += `
          <li>
            <span class="connection-label" style="${style}">‚Üí ${label}</span>
            <a class="internal-link" data-topic-id="${conn.to}" onclick="showTopic('${conn.to}')">${other.title}</a>
          </li>`;
      });
    } else {
      outHtml += `<li>None</li>`;
    }
    outHtml += `</ul>`;

    // Incoming: ÂÖ∂‰ªñ ‚Üí Êú¨‰∏ªÈ¢ò
    const backlinks = Object.keys(knowledgeBase).reduce((acc, id) => {
      const item = knowledgeBase[id];
      item?.connections?.forEach(c => { if (c.to === topicId) acc.push({ from: id, type: c.type }); });
      return acc;
    }, []);
    backlinks.sort((a,b)=> knowledgeBase[a.from].title.localeCompare(knowledgeBase[b.from].title));

    let inHtml = `<h4>To ${topic.title}</h4><ul>`;
    if (backlinks.length > 0) {
      backlinks.forEach(link => {
        const other = knowledgeBase[link.from];
        if (!other) return;
        const label = labelFor(link.type, 'in');            // Âèç‰πâ/‰∏ªÂä®ÊÄÅÔºàÂ¶Ç diagnoses / treatsÔºâ
        const style = chipStyleFor(link.type, isDark);
        inHtml += `
          <li>
            <a class="internal-link" data-topic-id="${link.from}" onclick="showTopic('${link.from}')">${other.title}</a>
            <span class="connection-label" style="${style}">${label} ‚Üí</span>
          </li>`;
      });
    } else {
      inHtml += `<li>No incoming links.</li>`;
    }
    inHtml += `</ul>`;

    connectionsPanel.innerHTML = outHtml + inHtml;
  }

  function setupPopover() {
    const popover = document.getElementById('popover');
    document.body.addEventListener('mouseover', e => {
      const link = e.target.closest('.internal-link');
      if (link) {
        const topicId = link.dataset.topicId;
        const topic = knowledgeBase[topicId];
        popover.innerHTML = `<h4>${getEmoji(topic?.primaryType)} ${topic?.title || ''}</h4><p>${topic?.content?.definition || ''}</p>`;
        popover.style.display = 'block';
        const rect = link.getBoundingClientRect();
        popover.style.left = `${rect.left + window.scrollX}px`;
        popover.style.top = `${rect.top + window.scrollY - popover.offsetHeight - 10}px`;
      }
    });
    document.body.addEventListener('mouseout', e => {
      const link = e.target.closest('.internal-link');
      if (link) { popover.style.display = 'none'; }
    });
  }

  // === Graph View (fixed) ===
  function showGraphModal(centerNodeId) {
    if (!centerNodeId || !knowledgeBase[centerNodeId]) {
      console.warn('Graph center node missing:', centerNodeId);
      return;
    }
    const modal = document.getElementById('graph-modal');
    modal.style.display = "block";

    setTimeout(() => {
      const connectedNodes = new Set([centerNodeId]);
      knowledgeBase[centerNodeId]?.connections?.forEach(conn => connectedNodes.add(conn.to));
      Object.keys(knowledgeBase).forEach(id => {
        knowledgeBase[id]?.connections?.forEach(conn => {
          if (conn.to === centerNodeId) connectedNodes.add(id);
        });
      });

      const nodesData = Array.from(connectedNodes)
        .filter(id => knowledgeBase[id])
        .map(id => ({
          id,
          label: `${getEmoji(knowledgeBase[id].primaryType)} ${knowledgeBase[id].title}`,
          group: knowledgeBase[id].primaryType
        }));

      const edgesData = Array.from(connectedNodes).flatMap(nodeId =>
        knowledgeBase[nodeId]?.connections
          ?.filter(c => connectedNodes.has(c.to))
          .map(c => ({
            from: nodeId,
            to: c.to,
            label: c.type.replace(/_/g,' '),
            arrows: 'to'
          })) || []
      );

      const container = document.getElementById('graph-container');
      const data = {
        nodes: new vis.DataSet(nodesData),
        edges: new vis.DataSet(edgesData)
      };

      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      // Â∞Ü CSS ÂèòÈáèËß£Êûê‰∏∫ÁúüÂÆûÈ¢úËâ≤Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖç Canvas Êó†Ê≥ïËØÜÂà´ var(--xxx)
      const css = getComputedStyle(document.documentElement);
      const groupColors = Object.fromEntries(
        Object.keys(EMOJI_MAP).map(type => {
          const bg = css.getPropertyValue(`--c-${type}-${isDark ? 'bg-dark' : 'bg-light'}`).trim();
          const bd = css.getPropertyValue(`--c-${type}-${isDark ? 'dark' : 'light'}`).trim();
          return [type, { color: { background: bg || '#ffffff', border: bd || '#333333' } }];
        })
      );

      const options = {
        nodes: {
          shape: 'box',
          borderWidth: 2,
          font: { size: 14, color: isDark ? '#e5e7eb' : '#212529' },
          margin: { top: 10, right: 15, bottom: 10, left: 15 }
        },
        edges: {
          width: 2,
          font: { size: 10, align: 'middle', color: isDark ? '#9ca3af' : '#6c757d', strokeWidth: 0 }
        },
        physics: {
          solver: 'forceAtlas2Based',
          forceAtlas2Based: { gravitationalConstant: -100, springLength: 150, centralGravity: 0.01 }
        },
        groups: groupColors
      };

      if (currentNetwork) {
        currentNetwork._resizeObserver?.disconnect?.();
        currentNetwork.destroy();
        currentNetwork = null;
      }

      currentNetwork = new vis.Network(container, data, options);

      currentNetwork.once('stabilized', () => currentNetwork && currentNetwork.fit({ animation: { duration: 300, easing: 'easeInOutQuad' } }));
      currentNetwork.fit();

      const ro = new ResizeObserver(() => currentNetwork && currentNetwork.fit());
      ro.observe(container);
      currentNetwork._resizeObserver = ro;

      currentNetwork.on('selectNode', (params) => {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          closeModal('graph-modal');
          showTopic(nodeId);
        }
      });

    }, 0);
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
    if (modalId === 'graph-modal' && currentNetwork) {
      currentNetwork._resizeObserver?.disconnect?.();
      currentNetwork.destroy();
      currentNetwork = null;
    }
  }

  document.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>
